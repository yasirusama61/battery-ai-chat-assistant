Refining CNN-based Heatmap Regression with Gradient-based Corner Points for Electrode Localization Lin Wu fiftywu@outlook.com Abstract We propose a method for detecting the electrode positions in lithium-ion batteries. The process begins by identifying the region of interest (ROI) in the battery’s X-ray image through corner point detection. A convolutional neural network is then used to regress the pole positions within this ROI. Finally, the regressed positions are optimized and corrected using corner point priors, significantly mitigating the loss of localization accuracy caused by operations such as feature map down-sampling and padding during network training. Our findings show that combining traditional pixel gradient analysis with CNN-based heatmap regression for keypoint extraction enhances both accuracy and efficiency, resulting in significant performance improvements. Keywords: Machine vision, Heatmap regression, Keypoint detection, Electrode localization 1. Introduction The quality of battery cells is directly linked to the precise localization and alignment of the electrodes. [1] The folding of the electrode sheets or poor alignment of the four corners of the electrode assembly in lithium-ion batteries can lead to reduced performance, overheating risks, mechanical damage, and safety hazards. Therefore, ensuring the accurate alignment and shape of the electrode sheets during the manufacturing process is crucial, particularly for lithium-ion batteries used in high-performance and high-safety applications, such as electric vehicles and energy storage systems. However, due to the multi-levels structure of the cells and the significant overlap between the electrode sheets, X-ray images often suffer from low brightness, high noise, and variations in pole area sizes and positions [2]. These challenges make accurate electrode detection particularly difficult. Existing automated detection algorithms fail to fully leverage the unique features of X- ray images, leading to a high rate of overkill. To this end, we propose a novel joint optimization framework that incorporates a gradient-based corner point detection method to refine CNN-based heatmap regression for electrode localization. Our contributions are summarized as follows: Preprint submitted to arxiv December 25, 2024arXiv:2412.17105v2  [cs.CV]  24 Dec 2024•The region of interest (ROI) corresponding to the pole area is efficiently identified in high- resolution X-ray images using corner point detection, that is, Oriented Features from Accel- erated Segment Test (OFAST) [3]. •A high-resolution neural network (HRNet) [4] with heatmap regression is employed to detect pole coordinates, enhancing model adaptability through various data augmentation tech- niques. •A confidence-based adjustment module is introduced to dynamically refine pole detection results by evaluating the confidence of the poles predicted by HRNet and their reference corners detected by OFAST. •Various evaluation metrics validate the effectiveness of our joint optimization framework, which combines CNN-based heatmap regression [5] and gradient-based corner point detec- tion. Additionally, PCS (Percentage of Correct Samples) is introduced as a novel metric to calculate the proportion of samples with maximum normalized error below a threshold. 2. Methodology Our framework for electrode localization and optimization is illustrated in the Fig. 1 (a). Given high-resolution X-ray images of the lithium-ion battery, we initially employ a corner point detection model to extract a set of corner points. These corner points are subsequently input into an ROI estimation module to identify a smaller area for further focus. Within this ROI, pole positions are detected using a CNN-based heatmap regression model. Finally, the pole positions predicted by the CNN model are refined and corrected by leveraging the corner points previously identified through gradient-based corner detection. 2.1. Corner Points and ROI Detection OFAST is an improvement on the traditional FAST (Features from Accelerated Segment Test) algorithm, aiming to enhance its rotation invariance. The core idea of OFAST is to detect corner points in an image based on local brightness changes and calculate the direction of each corner point, so that the algorithm can still maintain good matching results when facing rotation or posture changes. Due to the fact that X-ray images of lithium batteries are primarily grayscale images, and the brightness gradient features at the pole positions are very rich, we therefore use OFAST to extract corner points. As shown in Fig. 1 (b), these detected corner points (in green) are primarily concentrated in the pole region of the lithium battery, although they do not perfectly match the actual pole positions. It can be observed that at least the actual pole positions must have distinct brightness gradients. This phenomenon encourages us to make full use of the distribution information of these corner 2Figure 1: Framework of the proposed Electrode Localization and Optimization points. Specifically, let the detected set of corner points be denoted as Q={q1, q2, ..., q n}, qi∈R2, we first calculate their cluster center (only one cluster) as follows: x0, y0=1 nnX i=1qi (1) After obtaining the center point, we accumulate the row-wise grayscale values of the X-ray image to form a new ”pattern,” as shown in Fig. 1 (b). This pattern enables us to easily identify the upper and lower bounds of the ROI, which correspond to the locations where the row-wise accumulated gradient experiences a significant change. We set a threshold τto detect these gradient changes, and define two pointers: the upper pointer moves from 0 to y0with a step size ∆ b, while the lower pointer moves from the image height Htoy0with a step size ∆ a. This process can be formalized as follows: b= 0 + n∆b, n = 0,1,2, . . . , a =H−m∆a, m = 0,1,2, . . . (2) where nandmare the step indices, and ∆ band ∆ aare the step sizes for the upper and lower pointers, respectively. Once we have the upper bound band the lower bound a, we introduce a new variable λto control the width of the ROI, which is determined by the horizontal coordinate of the cluster center and the height of the ROI. We therefore achieve the left bound cand right bound das follows: c=x0−λ(b−a) (3) d=x0+λ(b−a) (4) where λis a scaling factor that adjusts the width of the ROI based on the cluster center’s horizontal position and the height of the ROI. 32.2. Electrode Regression Network Once we have the ROI, we can use any keypoint detection method to estimate the poles in the image. Due to the significant advantages of HRNet in high-resolution feature extraction and precise keypoint localization, it has been widely adopted for high-accuracy keypoint detection tasks. Additionally, HRNet utilizes heatmap regression to locate keypoints, which enhances the model’s accuracy in keypoint detection. Therefore, we choose HRNet as our electrode regression network. During training, we applied data augmentation techniques such as rotation, reflection, and other affine transformations. The heatmap regression network is trained using Mean Squared Error (MSE) as the loss function. The training set consists of approximately 2,000 samples, while the test set contains around 1,000 samples. 2.3. Post-Correction with Corner Points Due to the computational efficiency and hardware deployment considerations of heatmap regression-based 2D keypoint estimation models, the resolution of the feature maps is typically lower than the original input resolution. When determining the final keypoint coordinates, the feature map resolution is upsampled to match the original resolution. For example, in HRNet, the feature map scale is 1/4 of the input resolution. Additionally, operations such as multi-layer downsampling, upsampling, and padding inevitably introduce some discrepancy between the pre- dicted and ground truth keypoint coordinates. To further reduce this discrepancy, we propose a post-correction algorithm based on corner point detection. Specifically, for each predicted pole coordinate pifrom the regression network, the radius δis set, and the nearest corner point within the circle of radius δaround piis selected as the reference corner point qi, as shown in Fig. 1 (c). Note that if no corner points exist within the radius δ, the point piwill not have a reference corner. Although we have captured the pi, qipairs, inevitable noise or errors may still affect them, which is caused by neural network training and local brightness gradient patterns. Therefore, we need to evaluate the confidence of the two pole position estimates before a potential fusion and interaction, as shown in Fig. 1 (d). Before evaluating the confidence of pi, qi, we first need to establish a ”reference standard” which will be used to assess the affinity of piandqito this standard. This affinity represents the confidence information we aim to obtain. Our local feature extractor can be implemented in various ways, such as using BRIEF (Binary Robust Independent Elementary Features) [6] descriptors or other deep learning-based descriptors [7]. Here, we adopt a more efficient approach: for a given point xi, yi, we define a small square region centered around it, and compute the normalized brightness distribution histogram of this region as its local pattern. Due to the presence of both positive and negative terminals in lithium batteries, with slight differences in their local patterns, we use two colors in the figure: red for the positive terminal. To 4address this, we design a standard feature extractor that summarizes the local patterns of both the positive and negative terminals in an input X-ray image, calculating their average as the reference feature ri. Similarly, we use a patch feature extractor to extract the local features ui, viforpiand qiindividually. Thus the corresponding confidence αi, βican be achieved as follows: αi=<vi ||vi||,ri ||ri||>, β i=<ui ||ui||,ri ||ri||> (5) Once the confidence for each is captured as a measure of uncertainty, we naturally aggregate the pole estimates from both the pi:{xi, yi}andqi:{x′ i, y′ i}. ˆxi=αixi+βix′ i αi+βi,ˆyi=αiyi+βiy′ i αi+βi(6) where, ˆ xiand ˆyiare the refined pole coordinates. 3. Experimental Evaluation 3.1. Experimental setting We first apply OFAST to detect Ncorner points. Based on this, we determine the ROI and input it into HRNet. Finally, we use our confidence-based coordinate optimization module. We provide baseline results based on HRNet and compare the results with different choices of N, corresponding to different numbers of corner points extracted by OFAST. 3.2. Evaluation Metric We adopt diverse metrics [8] to compare different experimental settings including NME, PCK@0.5%, PCK@1.0% PCS@0.5% and PCS@1.0%. Normalized Mean Error (NME) is used to evaluate the accuracy of predicted keypoints com- pared to the ground truth. It calculates the mean of the normalized errors across all samples and keypoints, with a lower NME indicating better performance. NME =P sP ids,i err/di refP sP i1(7) where ds,i erris the error (distance) between the predicted and true coordinates for keypoint iin sample s.di refis the reference distance for keypoint i. Here we adopt the diagonal length of the ROI as reference distance. PCK (Percentage of Correct Keypoints) calculates the proportion of keypoints that are within the acceptable error threshold ( θ), normalized by the total number of keypoints. It is often used to evaluate keypoint detection accuracy, with a higher PCK indicating better performance. PCK θ=P sP iδ(ds,i err/ds ref⩽θ)P sP i1(8) 5PCS (Prcentage of Correct Samples) calculates the proportion of samples where the maximum normalized error (among all keypoints) is less than or equal to the threshold θ. A higher PCSmax θ indicates better performance, as more samples have their maximum error within the acceptable range. PCSmax θ=P sδ(Max i[ds,i err/ds ref]⩽θ)P s1(9) 3.3. Numerical Result As shown in Tabe. 1, the experimental results demonstrate that the addition of corner points significantly improves keypoint localization performance, especially when the number of corner points is increased. HRNet combined with corner points (particularly with N= 512) consis- tently outperforms the baseline HRNet across all evaluation metrics. These improvements indicate that corner points provide valuable information that enhances the precision of keypoint detection, particularly for tasks requiring high accuracy. Table 1: Performance comparison of different settings. Method NME(%) ↓PCK@0.5% ↑PCK@1.0% ↑PCS@0.5% ↑PCS@1.0% ↑ HRNet (Baseline) 0.658 0.421 0.818 0.239 0.965 HRNet + Corner points (N=128) 0.624 0.473 0.836 0.303 0.978 HRNet + Corner points (N=256) 0.611 0.486 0.847 0.337 0.978 HRNet + Corner points (N=512) 0.582 0.519 0.865 0.388 0.991 ∆Relative Gain 11.55% 23.28% 5.75% 62.34% 2.69% 4. Conclusion In this paper, we propose a joint optimization model that integrates CNN-based heatmap re- gression with local gradient-based corner point detection. This approach significantly improves the localization of pole coordinates in X-ray images of lithium batteries. Our findings suggest that, for keypoint extraction tasks using deep learning, combining traditional pixel gradient analysis methods with CNN-based heatmap regression is a promising strategy. This hybrid approach enhances both the accuracy and efficiency of the solution, leading to notable performance improvements. Acknowledge Thanks to Z.P.J. and Dr. H.D. for the discussions on this project from Fengchao Energy. 6References [1] A. du Baret de Lim´ e, T. Lein, S. Maletti, K. Schmal, S. Reuber, C. Heubner, A. Michaelis, Impact of electrode defects on battery cell performance: a review, Batteries & Supercaps 5 (10) (2022) e202200239. [2] S. Masuch, P. G¨ umbel, N. Kaden, K. Dr¨ oder, Applications and development of x-ray inspection techniques in battery cell production, Processes 11 (1) (2022) 10. [3] E. Rublee, V. Rabaud, K. Konolige, G. Bradski, Orb: An efficient alternative to sift or surf, in: 2011 International conference on computer vision, Ieee, 2011, pp. 2564–2571. [4] K. Sun, B. Xiao, D. Liu, J. Wang, Deep high-resolution representation learning for human pose estimation, in: Proceedings of the IEEE/CVF conference on computer vision and pattern recognition, 2019, pp. 5693–5703. [5] C. Payer, D. ˇStern, H. Bischof, M. Urschler, Regressing heatmaps for multiple landmark lo- calization using cnns, in: International conference on medical image computing and computer- assisted intervention, Springer, 2016, pp. 230–238. [6] M. Calonder, V. Lepetit, C. Strecha, P. Fua, Brief: Binary robust independent elementary features, in: Computer Vision–ECCV 2010: 11th European Conference on Computer Vision, Heraklion, Crete, Greece, September 5-11, 2010, Proceedings, Part IV 11, Springer, 2010, pp. 778–792. [7] D. DeTone, T. Malisiewicz, A. Rabinovich, Superpoint: Self-supervised interest point detec- tion and description, in: Proceedings of the IEEE conference on computer vision and pattern recognition workshops, 2018, pp. 224–236. [8] B. Yu, D. Tao, Heatmap regression via randomized rounding, IEEE Transactions on Pattern Analysis and Machine Intelligence 44 (11) (2021) 8276–8289. 7